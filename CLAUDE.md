# Tailscale Auth Key Generator Tool - Specification

## Overview
A standalone CLI tool written in Go that generates Tailscale authentication keys programmatically. Supports two authentication methods:
- **API Keys** (default, recommended): Direct authentication with Tailscale API keys
- **OAuth**: OAuth client credentials for advanced use cases

The tool outputs the generated auth key to stdout, allowing users to pipe or redirect it as needed for their Docker Compose workflows or other automation.

## Core Functionality
Generate Tailscale auth keys on-demand using:
1. **API keys** (default) - simpler, no tags required, expires every 90 days
2. **OAuth credentials** - requires tags, more complex setup

Credentials are stored securely in `pass` (the standard Unix password manager).

## Authentication Methods

### API Key Authentication (Default, Recommended)

**Benefits:**
- Simpler setup - no OAuth client required
- No mandatory tags requirement
- Direct API access

**Limitations:**
- API keys expire after 90 days and must be regenerated
- Must validate API key before each use

**Authentication Flow:**
1. Retrieve API key from `pass` or environment variable
2. Validate API key format (basic check)
3. Create auth key via `POST https://api.tailscale.com/api/v2/tailnet/-/keys` with Basic Auth
4. Output auth key to stdout (API key validity confirmed on successful creation)

### OAuth Authentication (Advanced)

**Benefits:**
- Access token refreshed automatically (1-hour expiry)
- More granular permissions control

**Limitations:**
- **Tags are mandatory**: Tailscale's API requires that all auth keys created via OAuth must specify at least one tag
- More complex setup process

**Authentication Flow:**
1. Retrieve OAuth client ID and secret from `pass`
2. Exchange OAuth credentials for short-lived API access token (1-hour expiry) via `POST https://api.tailscale.com/api/v2/oauth/token`
3. Use access token to create auth key via `POST https://api.tailscale.com/api/v2/tailnet/-/keys`
4. Output auth key to stdout

## Secret Storage Integration

### Pass Integration (Recommended)

**Default paths:**
- API Key: `tailscale/api-key`
- OAuth Client ID: `tailscale/oauth-client-id`
- OAuth Client Secret: `tailscale/oauth-client-secret`

Should support custom paths via config file. If secrets not found, enter interactive mode to guide user.

### Fallback to Environment Variables

**API Key Mode:**
- `TS_API_KEY`

**OAuth Mode:**
- `TS_OAUTH_CLIENT_ID`
- `TS_OAUTH_CLIENT_SECRET`

## Configuration Management

### Config File Location
`~/.config/jankey/config.yaml`

### Config File Schema
```yaml
# API Key configuration (default auth method)
api_key:
  pass_path_api_key: "tailscale/api-key"

# OAuth configuration (use with --use-oauth flag)
oauth:
  pass_path_client_id: "tailscale/oauth-client-id"
  pass_path_client_secret: "tailscale/oauth-client-secret"

# Auth key defaults
auth_key_defaults:
  ephemeral: false
  reusable: false
  preauthorized: true
  expiry_days: 7
  tags: []  # Optional for API key, required for OAuth
```

### Interactive Wizard
Run with `--init` flag:

1. Choose authentication method (API key or OAuth)
2. Configure credential storage (pass or environment variables)
3. Store credentials in pass (optional)
4. Configure default auth key characteristics
5. Configure tags (optional for API key, required for OAuth)
6. Write config file with user's preferences

### Auth Key Defaults

- `ephemeral: false` (device persists after disconnect)
- `reusable: false` (one-time use)
- `preauthorized: true` (auto-approve if device approval enabled)
- `expiry_days: 7` (auth key expires in 7 days)
- `tags`: Optional for API key mode, required for OAuth mode

## CLI Interface

### Basic Usage

**Using API Key (default):**
```bash
jankey
# Outputs: tskey-auth-xxxxxxxxxxxxx
```

**Using OAuth:**
```bash
jankey --use-oauth --tags tag:docker
# Outputs: tskey-auth-xxxxxxxxxxxxx
```

### Cleanup Command

**List keys created by jankey:**
```bash
jankey cleanup
# Shows all auth keys with "Generated by jankey" in description
```

**Delete all jankey-created keys (dry run):**
```bash
jankey cleanup --all --dry-run
# Shows what would be deleted without actually deleting
```

**Delete all jankey-created keys:**
```bash
jankey cleanup --all
# ⚠️ Deletes all auth keys created by jankey
```

### Flag Overrides
```bash
# API key mode with options
jankey \
  --ephemeral \
  --reusable \
  --expiry-days 14 \
  --tags tag:ci,tag:docker \
  --description "Auth key for prod containers"

# OAuth mode
jankey --use-oauth \
  --ephemeral \
  --tags tag:ci,tag:docker
```

### Flags

- `--init`: Run interactive configuration wizard
- `--use-oauth`: Use OAuth authentication instead of API key (default: false)
- `--ephemeral / -e`: Make key ephemeral (device auto-removed when offline)
- `--reusable / -r`: Make key reusable (can authenticate multiple devices)
- `--preauthorized / -p`: Pre-authorize device (skip approval if enabled)
- `--no-preauthorized`: Disable pre-authorization
- `--expiry-days <N>`: Set key expiry in days (1-90, default 7)
- `--tags <tag1,tag2>`: Comma-separated list of tags (optional for API key, REQUIRED for OAuth)
- `--description <text>`: Description for the auth key
- `--config <path>`: Use alternate config file
- `--json`: Output as JSON with metadata
- `--verbose / -v`: Show API interactions and debug info

## API Request Format

### OAuth Token Request
```http
POST https://api.tailscale.com/api/v2/oauth/token
Content-Type: application/x-www-form-urlencoded

client_id=<client_id>&client_secret=<client_secret>&grant_type=client_credentials
```

### Auth Key Creation Request (API Key)
```http
POST https://api.tailscale.com/api/v2/tailnet/-/keys
Authorization: Basic <base64(api_key:)>
Content-Type: application/json

{
  "capabilities": {
    "devices": {
      "create": {
        "reusable": false,
        "ephemeral": false,
        "preauthorized": true,
        "tags": []  // Optional for API keys
      }
    }
  },
  "expirySeconds": 604800,
  "description": "Generated by jankey"
}
```

### Auth Key Creation Request (OAuth)
```http
POST https://api.tailscale.com/api/v2/tailnet/-/keys
Authorization: Bearer <access_token>
Content-Type: application/json

{
  "capabilities": {
    "devices": {
      "create": {
        "reusable": false,
        "ephemeral": false,
        "preauthorized": true,
        "tags": ["tag:container", "tag:docker"]  // Required for OAuth
      }
    }
  },
  "expirySeconds": 604800,
  "description": "Generated by jankey"
}
```

**Note**: `expirySeconds` of 604800 = 7 days. Use 0 for maximum 90-day expiry.

## Error Handling

### Common Error Scenarios

1. **Pass not installed or secrets not found**
   - Suggest installing pass or provide instructions to store secrets
   - Offer to use environment variables instead (TS_API_KEY or TS_OAUTH_CLIENT_ID/SECRET)

2. **API key expired or invalid**
   - Clear error message: "API key is invalid or expired (401)"
   - Provide link to regenerate: https://login.tailscale.com/admin/settings/keys
   - Remind that API keys expire after 90 days

3. **OAuth credentials invalid**
   - Clear error message with link to Tailscale OAuth client setup docs

4. **Tags not specified for OAuth**
   - Explain that tags are required when using OAuth
   - Suggest running `--init` to configure defaults or use `--tags` flag

5. **API errors**
   - Parse and display Tailscale API error messages
   - Common: "exactly one capability scope must be populated" (API format issue)
   - Common: "API token invalid" (OAuth credentials wrong)

6. **Network errors**
   - Retry logic with exponential backoff
   - Clear error if Tailscale API unreachable

## Output Modes

### Default (stdout)
```
tskey-auth-k5aBcDeFgH1JkLmNoPqRsTuVwXyZ
```

### JSON Mode (--json)
```json
{
  "key": "tskey-auth-k5aBcDeFgH1JkLmNoPqRsTuVwXyZ",
  "id": "k5aBcD",
  "created": "2025-09-30T10:30:00Z",
  "expires": "2025-10-07T10:30:00Z",
  "capabilities": {
    "ephemeral": false,
    "reusable": false,
    "preauthorized": true
  },
  "tags": ["tag:container", "tag:docker"]
}
```

### Verbose Mode (--verbose)
Shows:
- API key validation (redacted) or OAuth token request/response (redacted)
- API access token obtained (OAuth mode)
- Auth key creation request
- Auth key creation response

## User Workflow Integration

### Example: Docker Compose with Tailscale Sidecar

**Using API Key (default):**
```bash
# Generate auth key and use in docker compose
export TS_AUTHKEY=$(jankey)
docker compose up -d
```

**Using OAuth:**
```bash
# Generate auth key with OAuth
export TS_AUTHKEY=$(jankey --use-oauth --tags tag:docker)
docker compose up -d
```

Or in compose file:
```yaml
services:
  app:
    image: myapp:latest

  tailscale:
    image: tailscale/tailscale:latest
    environment:
      - TS_AUTHKEY=${TS_AUTHKEY}
      - TS_STATE_DIR=/var/lib/tailscale
```

## Interactive Mode Features

### First-Run Experience (--init)

1. Welcome message explaining the tool
2. **Choose authentication method:**
   - API Key (recommended, simpler)
   - OAuth (advanced, requires tags)
3. Check for pass installation
4. Configure credential storage and optionally store credentials
5. Set up default auth key preferences
6. Configure tags (optional for API key, required for OAuth)
7. Save configuration

### API Key Setup
- Guide user to generate API key at: https://login.tailscale.com/admin/settings/keys
- Explain 90-day expiry limitation
- Store in pass or provide TS_API_KEY environment variable

### OAuth Setup
- Guide OAuth client setup: https://tailscale.com/kb/1215/oauth-clients
- Explain required scopes: `auth_keys` or `devices:write`
- Explain tag requirement and help configure
- Store credentials in pass or provide environment variables

### Tag Configuration Help
For OAuth mode (tags are mandatory):
- Explain tag purpose in simple terms
- Provide common examples: `tag:docker`, `tag:ci`, `tag:services`, `tag:container`
- Link to Tailscale ACL documentation
- Suggest creating a dedicated tag for this tool if user unsure

## Technical Implementation Notes

### Go Dependencies

- Likely need: `tailscale.com/client/tailscale` (official Tailscale Go client if available)
- HTTP client for OAuth/API calls
- YAML parser for config file
- Exec `pass` command for secret retrieval
- Consider: `cobra`/`cli` for CLI framework

### API Response Parsing
The auth key creation response returns:
```json
{
  "id": "k5aBcD",
  "key": "tskey-auth-k5aBcDeFgH1JkLmNoPqRsTuVwXyZ",
  "created": "2025-09-30T10:30:00Z",
  "expires": "2025-10-07T10:30:00Z",
  "capabilities": {
    "devices": {
      "create": {
        "reusable": false,
        "ephemeral": false,
        "preauthorized": true,
        "tags": ["tag:container"]
      }
    }
  }
}
```
Extract the `key` field for stdout output.

## Security Considerations

- Never log or print OAuth credentials
- Sanitize output in verbose mode
- Clear access tokens from memory after use
- Recommend `pass` over environment variables
- Don't store auth keys anywhere (stateless tool)

## Testing Checklist

**API Key Mode:**
- [ ] API key validation with valid key
- [ ] API key validation with expired/invalid key
- [ ] Auth key creation with API key
- [ ] Auth key creation with optional tags
- [ ] Environment variable fallback (TS_API_KEY)

**OAuth Mode:**
- [ ] OAuth token exchange with valid credentials
- [ ] OAuth token exchange with invalid credentials
- [ ] Auth key creation with OAuth (tags required)
- [ ] Environment variable fallback (TS_OAUTH_CLIENT_ID/SECRET)

**General:**
- [ ] Auth key creation with various flag combinations
- [ ] Config file creation and loading
- [ ] Pass integration (secrets present and missing)
- [ ] Error handling for all API error responses
- [ ] Interactive wizard flow (both auth methods)
- [ ] Output modes (default, JSON, verbose)

## Documentation Requirements

- README with quick start guide
- API key setup instructions (default, recommended)
- OAuth client setup instructions (advanced)
- Tag setup and ACL basics
